---
title: QGISçš„æ•°æ®æ ¼å¼æ‹“å±•æ’ä»¶å¼€å‘
date: 2020-10-29
author: Falldio
location: æ­¦æ±‰
layout: blog
tags: 
    - GIS
    - CPP
---

# QGISçš„æ•°æ®æ ¼å¼æ‹“å±•æ’ä»¶å¼€å‘

VCTæ ¼å¼æ˜¯æˆ‘å›½åœ¨ã€Šåœ°ç†ç©ºé—´æ•°æ®äº¤æ¢æ ¼å¼ã€‹è¿™ä¸€å›½å®¶æ ‡å‡†æ–‡ä»¶ä¸­åˆ¶å®šçš„çŸ¢é‡æ•°æ®äº¤æ¢æ ¼å¼ã€‚å›½äº§çš„GISè½¯ä»¶ä¸€èˆ¬æœ‰å¯¹VCTæ ¼å¼çš„æ”¯æŒ,ä½†æ˜¯åœ¨QGISç­‰å›½é™…GISä¸Šæ”¯æŒè¾ƒå°‘ğŸ˜…ğŸ˜…ã€‚æˆ‘å°è¯•ç€åœ¨QGISä¸­é€šè¿‡ç¼–å†™C++æ’ä»¶çš„æ–¹å¼,å¢åŠ å¯¹VCTæ ¼å¼çš„æ”¯æŒï¼ŒğŸ¤”ğŸ¤”ğŸ¤”é€”ä¸­å‘ç°QGISæ‹“å±•æ•°æ®æ ¼å¼çš„èµ„æ–™è¿˜æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥è®°ä¸‹ä¸€ç¯‡åšå®¢ï¼Œå¦‚æœæœ‰ç†è§£ä¸åˆ°ä½çš„åœ°æ–¹ï¼Œè¿˜æœ›åŠæ—¶æŒ‡å‡ºã€‚è¯¥å°é¡¹ç›®çš„ä»£ç è§[Github](https://github.com/Falldio/QgsVctDataProvider/)ã€‚

> è¿™ç¯‡åšæ–‡å¾ˆåŸå§‹äº†ï¼Œä¹‹å‰æ˜¯å‘åœ¨[CSDN](https://blog.csdn.net/Falldio/article/details/109367377?spm=1001.2014.3001.5502)é‡Œçš„ï¼Œä½†æ˜¯å›¾ç‰‡æ²¡æœ‰æ¬è¿åˆ°å›¾åºŠï¼Œanywayä¹Ÿä¸æ˜¯å¾ˆé‡è¦çš„ç±»å›¾ã€‚æˆ‘çš„å…´è¶£å·²ç»ä¸åœ¨CPPçš„å®¢æˆ·ç«¯ä¸Šäº†ï¼Œä»æŸç§è§’åº¦ä¸Šï¼ŒGISçš„å‘å±•ä¼¼ä¹ä¹Ÿä¸åº”è¯¥å±€é™äºä¼ ç»Ÿçš„æ¡Œé¢ç«¯è½¯ä»¶ï¼Œå› æ­¤æˆ‘æ¯”è¾ƒæ€€ç–‘è¿™ç¯‡æ–‡ç« åˆ°åº•è¿˜æœ‰å¤šå¤§ä»·å€¼ã€‚

------

## ç¯å¢ƒé…ç½®

å¼€å‘ç¯å¢ƒï¼šVS 2015

Qtç‰ˆæœ¬ï¼š5.11.2

QGISç‰ˆæœ¬ï¼š3.12ï¼ˆä¸‹è½½ä¸€ä»½æºä»£ç å’Œå‘è¡Œç‰ˆè½¯ä»¶ï¼Œè®²é“ç†å¯ä»¥åªä¸‹è½½æºä»£ç ç„¶åè‡ªå·±ç¼–è¯‘å‡ºdebugç‰ˆæœ¬çš„ï¼Œå†™æ’ä»¶æ—¶è¾“å‡ºåº”è¯¥ä¹Ÿæ›´æ–¹ä¾¿ï¼Œä½†æ˜¯æˆ‘å¤ªèœäº†ä¸æ‡‚cmakeï¼Œç¼–è¯‘ä¸å‡ºæ¥:cry:ï¼Œå°±æ‹¿æºä»£ç å»çœ‹å†…éƒ¨åŸç†ï¼Œç„¶åæŠŠæ’ä»¶å†™å¥½äº†æ”¾è¿›è½¯ä»¶é‡Œå†æµ‹è¯•äº†:joy:å°±æ›´åŠ éº»çƒ¦ã€‚â€‹ï¼‰

------

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨VS 2015çš„èœå•æ ç‚¹å‡»`å·¥å…·`->`æ‰©å±•å’Œæ›´æ–°`ï¼Œåœ¨`æ‹“å±•å’Œæ›´æ–°`çª—å£çš„å·¦ä¾§é€‰æ‹©èœå•ä¸­é€‰æ‹©`è”æœº`ï¼Œç„¶åæœç´¢qtï¼Œé€‰æ‹©æœç´¢ç»“æœä¸­çš„ç¬¬ä¸€é¡¹â€œ*Qt Visual Studio Tools*â€ï¼Œå®‰è£…å®Œæˆåé‡å¯VS 2015ï¼Œå¯ä»¥çœ‹åˆ°èœå•æ å·²ç»å‡ºç°äº†`Qt VS Tools`ï¼Œç‚¹å‡»`Qt VS Tools`->`Qt Options`ï¼Œåœ¨`Qt Versions`æ ‡ç­¾ä¸‹è®¾ç½®Qtç¼–è¯‘å™¨è·¯å¾„ï¼Œä¾‹å¦‚ï¼Œæˆ‘çš„å°±æ˜¯â€œ*C:\Qt\Qt5.11.2\5.11.2\msvc2015*â€ã€‚

è®¾ç½®å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œæ¨¡æ¿æ˜¯*Qt Class Library*ï¼Œå› ä¸ºæˆ‘ä»¬è¦å¼€å‘çš„æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œæœ€åç”Ÿæˆçš„æ˜¯ä¸€ä¸ªdllæ–‡ä»¶ï¼Œè€Œéä¸€ä¸ªå¸¦å›¾å½¢ç•Œé¢çš„åº”ç”¨ã€‚:thinking:æˆ‘ä»¬ç‚¹å‡»èœå•æ ä¸­çš„`é¡¹ç›®`->`å±æ€§`ï¼Œåœ¨å±æ€§é¡µä¸­é€‰æ‹©`C/C++`->`å¸¸è§„`ï¼Œé€‰æ‹©å³ä¾§é¡µé¢ä¸­çš„`é™„åŠ åŒ…å«ç›®å½•`ï¼Œæ·»åŠ QGISå’ŒQtçš„åº“è·¯å¾„ï¼Œä»¥æˆ‘ä¸ºä¾‹ï¼Œè·¯å¾„åˆ†åˆ«ä¸ºï¼š

â€‹*C:\Users\lenovo\Desktop\osgeow\apps\Qt5\include\QtGui*

â€‹*C:\Users\lenovo\Desktop\osgeow\apps\Qt5\include\QtWidgets*

â€‹*C:\Users\lenovo\Desktop\osgeow\apps\Qt5\include\QtXml*

â€‹*C:\Users\lenovo\Desktop\osgeow\apps\Qt5\include\QtCore*

â€‹*C:\Users\lenovo\Desktop\osgeow\apps\qgis\include*

â€‹*C:\Users\lenovo\Desktop\osgeow\include*

â€‹ç„¶åç‚¹å‡»å±æ€§é¡µä¸­çš„`é“¾æ¥å™¨`->`å¸¸è§„`->`é™„åŠ åº“ç›®å½•`ï¼Œæ·»åŠ QGISçš„libæ–‡ä»¶è·¯å¾„ï¼Œä¾‹å¦‚æˆ‘çš„ï¼š

â€‹*C:\Users\lenovo\Desktop\osgeow\apps\qgis\lib*

â€‹ç‚¹å‡»`è¾“å…¥`->`é™„åŠ ä¾èµ–é¡¹`ï¼Œæ·»åŠ *Qt5Xml.lib*ã€*Qt5Widgets.lib*ã€*qgis_core.lib*ã€*qgis_app.lib*ã€*qgis_gui.lib*ã€‚è‡³æ­¤ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®å°±å¤§åŠŸå‘Šæˆå•¦!:tada::tada::tada:

## 2. æŠ€æœ¯è·¯çº¿

### 2.1 åŸºç±»è¯´æ˜

â€‹æŸ¥çœ‹æºä»£ç å¯çŸ¥ï¼ŒQGISå¯¹æ•°æ®æ ¼å¼çš„æ”¯æŒæ˜¯ä»¥æ‹“å±•æ’ä»¶çš„æ–¹å¼å®ç°çš„ï¼Œæ‰“å¼€è½¯ä»¶ä¹‹åï¼ŒQGISä¼šé€šè¿‡*QgsProviderRegistry*ç±»æ‰«æ*Plugin Path*ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆ*Plugin Path*ä¸€èˆ¬ä½äºQGISç›®å½•ä¸‹çš„pluginsæ–‡ä»¶å¤¹ï¼‰ï¼Œæ‰¾åˆ°å…¶ä¸­çš„æ•°æ®æºæ’ä»¶ï¼Œå³å„ç§dllæ–‡ä»¶ä¸­çš„*QgsVectorDataProvider*çš„ç»§æ‰¿ç±»ã€‚å› æ­¤æˆ‘ä»¬çš„æ€è·¯å°±æ˜¯è‡ªå·±ç»§æ‰¿*QgsVectorDataProvider*ï¼Œç”¨äºé“¾æ¥çŸ¢é‡å›¾å±‚å’ŒVCTæ–‡ä»¶æ•°æ®æºã€‚

```cpp
QgsProviderRegistry::QgsProviderRegistry( const QString &pluginPath )
{
  // At startup, examine the libs in the qgis/lib dir and store those that
  // are a provider shared lib
  // check all libs in the current plugin directory and get name and descriptions
  //TODO figure out how to register and identify data source plugin for a specific
  //TODO layer type
#if 0
  char **argv = qApp->argv();
  QString appDir = argv[0];
  int bin = appDir.findRev( "/bin", -1, false );
  QString baseDir = appDir.left( bin );
  QString mLibraryDirectory = baseDir + "/lib";
#endif
  mLibraryDirectory.setPath( pluginPath );
  init();
}
```

â€‹ç”±äºæ²¡æ‰¾åˆ°ç›¸å…³èµ„æ–™ï¼Œæ‰€ä»¥æˆ‘åœ¨ç±»çš„ç»“æ„ä¸Šå‚è€ƒäº†æºä»£ç ä¸­çš„*DelimitedText*å’Œ*Memory*çš„ç»“æ„ï¼Œä»£ç åˆ†åˆ«ä½äºQGISæºä»£ç æ ¹ç›®å½•ä¸‹çš„â€œ*providers\delimitedtext*â€å’Œâ€œ*src\core\providers\memory*â€ç›®å½•ä¸‹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›æ’ä»¶ä¸»è¦ç»§æ‰¿äº†*QgsVectorDataProvider*ã€*QgsProviderMetadata*ã€*QgsAbstractDataSourceWidget*ã€*QgsProviderGuiMetadata*ã€*QgsSourceSelectProvider*ã€*QgsAbstractFeatureSource*ã€*QgsAbstractFeatureIteratorFromSource< T >*ç­‰ã€‚

â€‹*QgsVectorDataProvider*æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£å°†çŸ¢é‡æ–‡ä»¶æ•°æ®æºæ–‡ä»¶å’ŒçŸ¢é‡å›¾å±‚è”ç³»èµ·æ¥ï¼Œæ–‡ä»¶çš„è¯»å–å’Œè¦ç´ çš„æ”¹åŠ¨éƒ½é€šè¿‡*QgsVectorDataProvider*å®ç°ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å°†VCTæ–‡ä»¶çš„è¯»å†™å†™åœ¨è¿™é‡Œï¼Œåé¢ä¹Ÿå¯ä»¥ç”¨ä»£ç æ”¯æŒè¦ç´ çš„ç¼–è¾‘ä¿å­˜ã€‚

â€‹*QgsProviderMetadata*è´Ÿè´£ä¿å­˜*QgsVectorDataProvider*çš„keyå’Œdescriptionï¼Œè¿™åœ¨*QgisApp*çš„åˆå§‹åŒ–ä¸­æ˜¯å¿…è¦çš„ï¼ŒQGISä¼šé€šè¿‡*QgsProviderMetadata*çš„createProvideræ–¹æ³•æ¥åˆ›å»ºæˆ‘ä»¬å®šä¹‰çš„dataproviderã€‚å¦å¤–*QgsProviderMetadata*è¦æ±‚å®ç°çš„encodeUriå’ŒdecodeUriæ–¹æ³•åœ¨å¯¹dataproviderçš„å¿…è¦å‚æ•°uriçš„å¤„ç†ä¸Šä¹Ÿå¾ˆé‡è¦ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬çš„uriåªæ˜¯vctæ–‡ä»¶çš„å‚¨å­˜è·¯å¾„ï¼Œå› æ­¤è¿™é‡Œä¸æ˜¯é‡ç‚¹ã€‚

â€‹*QgsAbstractDataSourceWidget*æ˜¯QGISä¸­æ–‡ä»¶é€‰æ‹©æ¡†çš„åŸºç±»ï¼Œè¦å®ç°é€‰æ‹©æ•°æ®æºæ–‡ä»¶ï¼Œæ·»åŠ ç›¸åº”å›¾å±‚çš„åŠŸèƒ½ï¼Œå°±å¿…é¡»ç»§æ‰¿è¿™ä¸ªæ¥å£ï¼Œç»§æ‰¿ç±»ä¸»è¦è´Ÿè´£æ–‡ä»¶é€‰æ‹©çª—å£çš„ç”¨æˆ·æ“ä½œé€»è¾‘ã€‚*QgsProviderGuiMetadata*å’Œ*QgsSourceSelectProvider*ä¹‹é—´çš„å…³ç³»ï¼Œå’Œå‰é¢æåˆ°çš„*QgsProviderMetadata*ä¸*QgsVectorDataProvider*çš„å…³ç³»ç›¸ä¼¼ï¼š*QgsProviderGuiMetadata*åœ¨*QgsDataSourceManager*åˆå§‹åŒ–æ—¶ä¼šæä¾›*QgsSourceSelectProvider*çš„Listï¼Œæˆ‘ä»¬è‡ªå·±ç»§æ‰¿çš„*QgsSourceSelectProvider*ä¹Ÿæ˜¯è¿™æ ·åˆ›å»ºå®ä¾‹çš„ã€‚è€Œ*QgsSourceSelectProvider*åˆ™å­˜æ”¾äº†ä¸€äº›å¿…è¦çš„å‰ç«¯è¯´æ˜ä¿¡æ¯ï¼Œæ¯”å¦‚å›¾æ ‡ï¼Œè¯´æ˜æ–‡å­—ç­‰ï¼Œè¿™é‡Œä¹Ÿå®šä¹‰äº†æˆ‘ä»¬è‡ªå·±çš„çª—å£åœ¨QgsDataSourceManagerä¸­åŒå…¶ä»–çª—å£çš„ç›¸å¯¹é¡ºåºã€‚

â€‹*QgsAbstractFeatureSource*ç”¨äºå­˜æ”¾æˆ‘ä»¬ä»æ–‡ä»¶ä¸­è¯»å–çš„è¦ç´ ï¼Œ*QgsAbstractFeatureIteratorFromSource< T >*åˆ™å¯ä»¥ä»ç›¸åº”çš„*QgsAbstractFeatureSource*å®ç°ç±»ä¸­å¯¹è¦ç´ è¿›è¡Œéå†ç­‰æ“ä½œã€‚

æ€»çš„æ¥çœ‹ï¼Œç”¨æˆ·æ‰“å¼€æ–‡ä»¶é€‰æ‹©çª—å£ï¼Œé€‰æ‹©vctæ–‡ä»¶ï¼Œåˆ°QGISæ·»åŠ å›¾å±‚å¯ä»¥åˆ†ä¸ºç”¨æˆ·æ“ä½œå’Œåå°å“åº”ä¸¤å—ã€‚*QgsAbstractDataSourceWidget*ã€*QgsProviderGuiMetadata*å’Œ*QgsSourceSelectProvider*è´Ÿè´£ä»åˆ›å»ºæ–‡ä»¶é€‰æ‹©çª—å£ï¼Œå¹¶æ¥æ”¶ç”¨æˆ·è¾“å…¥ä¿¡æ¯ã€‚*QgsProviderMetadata*ã€*QgsVectorDataProvider*ã€*QgsAbstractFeatureSource*å’Œ*QgsAbstractFeatureIteratorFromSource< T >*è´Ÿè´£æŒ‰ç…§å°†è¯»å–åˆ°çš„æ•°æ®è½¬æ¢æˆæ–°å»ºçŸ¢é‡å›¾å±‚æ‰€å¿…é¡»çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜å¯ä»¥è¿›ä¸€æ­¥æ‹“å±•ï¼Œæ”¯æŒè¦ç´ çš„ç¼–è¾‘ã€ç©ºé—´ç´¢å¼•çš„åˆ›å»ºç­‰åŠŸèƒ½ã€‚

### 2.2 ç»§æ‰¿ç±»çš„éƒ¨åˆ†å®ç°

ä»2.1 åŸºç±»è¯´æ˜è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯åˆ†åˆ«ç»§æ‰¿ä¸Šè¿°å‡ ä¸ªæŠ½è±¡ç±»ï¼Œåœ¨è¿™å‡ ä¸ªç±»é‡Œé¢å†™è‡ªå·±çš„é€»è¾‘å³å¯ã€‚ä¸‹é¢æ˜¯æˆ‘è‡ªå·±çš„ç»§æ‰¿ç±»ï¼Œä»¥åŠä¸€äº›æ¯”è¾ƒé‡è¦çš„ï¼Œéœ€è¦å®ç°çš„æ–¹æ³•ã€‚

#### 2.2.1 QgsVctProvider

![QgsVctProvider](https://img-blog.csdnimg.cn/20201029193003382.png#pic_center)

*QgsVctProvider*å¯ä»¥è¯´æ˜¯è¿™é‡Œçš„ä¸»ç±»ï¼Œé¦–å…ˆéœ€è¦å®ç°*QgsVectorDataProvider*é‡Œé¢çš„çº¯è™šå‡½æ•°ï¼ŒåŒ…æ‹¬*featureSource*ã€*storageType*ã€*getFeatures*ã€*wkbType*ã€*featureCount*ã€*fields*ã€*capabilities*ã€*createSpatialIndex*ã€*hasSpatialIndex*ã€*name*ã€*description*ã€*extent*ã€*isValid*ã€*crs*ã€*setSubsetString*ã€*supportsSubsetString*ã€*subsetString*ç­‰ã€‚è¿™äº›å‡½æ•°ä¸€èˆ¬éƒ½æ˜¯è¿”å›å¯¹åº”å›¾å±‚çš„æŸäº›ä¿¡æ¯ï¼Œå¦‚ç©ºé—´å‚è€ƒç³»ï¼Œè¦ç´ æ€»æ•°ç­‰ï¼Œæ ¹æ®è‡ªå·±æ•°æ®æ ¼å¼æ–‡ä»¶ç¡®å®šå³å¯ï¼Œç„¶ååœ¨*capabilities*å‡½æ•°ä¸­æˆ‘ä»¬éœ€è¦è¿”å›è¿™ä¸ªdataProvideræ”¯æŒçš„åŠŸèƒ½ï¼Œè¯¦è§[QGISçš„å®˜æ–¹æ–‡æ¡£](https://qgis.org/api/classQgsVectorDataProvider.html#a1a360c9e78933697b9f9be334cfcaf7a)ã€‚å¦‚æœä¸æ”¯æŒæŸäº›åŠŸèƒ½ï¼Œåœ¨å¯¹åº”çš„å‡½æ•°é‡Œå¯ä»¥ç›´æ¥è¿”å›falseï¼Œæ¯”å¦‚ä¸æ”¯æŒç©ºé—´ç´¢å¼•åˆ›å»ºçš„è¯ï¼Œ*createSpatialIndex*å¯ä»¥ç›´æ¥è¿”å›falseã€‚ç”±äºæˆ‘ä»¬å½“å‰çš„ç›®æ ‡æ˜¯æ”¯æŒæ–‡ä»¶çš„è¯»å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å‚æ•°å¦‚ä¸‹é¢æ‰€ç¤ºï¼š

```cpp
QgsVectorDataProvider::Capabilities QgsVctProvider::capabilities() const {
    return AddFeatures | DeleteFeatures | ChangeGeometries |
        ChangeAttributeValues | AddAttributes | DeleteAttributes | RenameAttributes;
}
```

*getFeatures*å‡½æ•°å°†æ ¹æ®ç‰¹å®šçš„è¯·æ±‚è¿”å›ä¸€ä¸ª*QgsFeatureIterator*ï¼Œè¿™ä¸ªiteratoræ‰€å¯¹åº”çš„è¦ç´ æ˜¯ç¬¦åˆè¯·æ±‚æ¡ä»¶çš„å…¨éƒ¨è¦ç´ ã€‚

```cpp
QgsFeatureIterator QgsVctProvider::getFeatures(const QgsFeatureRequest &request) const {
    return QgsFeatureIterator(new QgsVctFeatureIterator(new QgsVctFeatureSource(this), true, request));
}
```

æœ€åæˆ‘ä»¬åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œè¿˜éœ€è¦å…ˆåˆ©ç”¨*setNativeTypes*æ–¹æ³•è®¾ç½®è¿™ä¸ªdataProvideræ”¯æŒçš„å­—æ®µç±»å‹ï¼Œç„¶åå†å®ç°æ–‡ä»¶çš„è¯»å–ï¼Œå› ä¸ºå½“ç”¨æˆ·é€‰æ‹©äº†ä¸€ä¸ªæ–‡ä»¶ä¹‹åï¼ŒQGISä¼šç›´æ¥äº§ç”Ÿä¸€ä¸ªå¯¹åº”çš„*dataProvider*å®ä¾‹ã€‚å…·ä½“çš„æ–‡ä»¶è¯»å–ä»£ç è¿™é‡Œä¸æï¼Œé€»è¾‘æ˜¯*QgsVctProvider*åœ¨æ„é€ å‡½æ•°ä¸­å¾—åˆ°äº†uriï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶è·¯å¾„ï¼ˆä»æ–‡ä»¶é€‰æ‹©çª—å£å¾—åˆ°ï¼‰ï¼Œç„¶åè°ƒç”¨é¢„å…ˆå†™å¥½çš„*writeData*æ–¹æ³•è¯»å–å¹¶å­˜æ”¾æ•°æ®ã€‚

```cpp
QgsVctProvider::QgsVctProvider(const QString &uri, const ProviderOptions &options)
    : QgsVectorDataProvider(uri, options) {
    // Add supported types to enable creating expression fields in field calculator
    setNativeTypes(QList<NativeType>()
        //string type
        << QgsVectorDataProvider::NativeType(tr("Char"), QStringLiteral("Char"), QVariant::Char, 0, 10)
        << QgsVectorDataProvider::NativeType(tr("Varchar"), QStringLiteral("Varchar"), QVariant::String, -1, -1)

        //interger types
        << QgsVectorDataProvider::NativeType(tr("Int1"), QStringLiteral("Int1"), QVariant::Int, -1, -1, 0, 0)
        << QgsVectorDataProvider::NativeType(tr("Int2"), QStringLiteral("Int2"), QVariant::Int, -1, -1, 0, 0)
        << QgsVectorDataProvider::NativeType(tr("Int4"), QStringLiteral("Int4"), QVariant::Int, -1, -1, 0, 0)
        << QgsVectorDataProvider::NativeType(tr("Int8"), QStringLiteral("Int8"), QVariant::Int, -1, -1, 0, 0)

        //floating point
        << QgsVectorDataProvider::NativeType(tr("Float"), QStringLiteral("Float"), QVariant::Double, -1, -1, -1, -1)
        << QgsVectorDataProvider::NativeType(tr("Double"), QStringLiteral("Double"), QVariant::Double, -1, -1, -1, -1)

        //date types
        << QgsVectorDataProvider::NativeType(tr("Date"), QStringLiteral("Date"), QVariant::Date, -1, -1, -1, -1)
        << QgsVectorDataProvider::NativeType(tr("Time"), QStringLiteral("Time"), QVariant::Time, -1, -1, -1, -1)
        << QgsVectorDataProvider::NativeType(tr("Datetime"), QStringLiteral("Datetime"), QVariant::DateTime, -1, -1, -1, -1)

        //binary type: store file path in a string
        << QgsVectorDataProvider::NativeType(tr("Varbin"), QStringLiteral("Varbin"), QVariant::String, -1, -1)
    );

    mUri = uri;
    readData(mUri);
    mNextFeatureId = featureCount() + 1;
}
```

#### 2.2.2 QgsVctFeatureSource

![QgsVctFeatureSource](https://img-blog.csdnimg.cn/20201029193034218.png#pic_center)

*QgsVCTFeatureSource*ä¸­è¦å®ç°çš„æ–¹æ³•åªæœ‰æ„é€ å‡½æ•°å’Œ*getFeatures*ã€‚åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œ*æˆ‘ä»¬éœ€è¦å–å¾—QgsVCTProvider*ä¸­çš„ä¸€äº›å¿…è¦æ•°æ®ï¼Œæ¯”å¦‚æ‰€æœ‰è¦ç´ ï¼Œæ‰€æœ‰å­—æ®µç­‰ã€‚*getFeatures*è¿”å›å¯¹åº”çš„Iteratorç±»ã€‚

```cpp
QgsVctFeatureSource::QgsVctFeatureSource(const QgsVctProvider *p)
    : mExtent(p->mExtent)
    , mGeometryType(p->mGeometryType)
    , mCrs(p->mCrs)
    , mFeatures(p -> mFeatures)
    , mFields(p->mFields)
{
}

QgsFeatureIterator QgsVctFeatureSource::getFeatures(const QgsFeatureRequest &request) {
    return QgsFeatureIterator(new QgsVctFeatureIterator(this, false, request));
}
```

#### 2.2.3 QgsVctFeatureIterator

![QgsVctFeatureIterator](https://img-blog.csdnimg.cn/20201029193052890.png#pic_center)

*QgsVctFeatureIterator*ä¸­çš„å…³é”®å‡½æ•°ä¸º*rewind*ã€*close*å’Œ*fetchFeature*ã€‚

â€‹*rewind*å‡½æ•°å°†Iteratorçš„æŒ‡å‘é‡å®šå‘ä¸ºç¬¬ä¸€ä¸ªè¦ç´ ã€‚

```cpp
bool QgsVctFeatureIterator::rewind() {
    if (mClosed)
        return false;
    mSelectIterator = mSource->mFeatures.constBegin();

    eturn true;
}
```

*close*å‡½æ•°å°†å…³é—­è¿™ä¸ªIteratorï¼Œå½“è¦ç´ çš„æ“ä½œå‡ºç°å¼‚å¸¸æ—¶åº”è¯¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚

```cpp
bool QgsVctFeatureIterator::close() {
    if (mClosed)
        return false;

    iteratorClosed();

    return true;
}
```

â€‹*fetchFeature*å‡½æ•°æ˜¯ä¸ºäº†æŸ¥çœ‹è¦ç´ é›†ä¸­æ˜¯å¦å­˜åœ¨è¦æ‰¾çš„è¦ç´ ï¼ŒQGISåœ¨æ¯ä¸€æ¬¡ç»˜åˆ¶æ—¶ä¼¼ä¹éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘å¯¹å®ƒçš„ä½œç”¨è¿˜ä¸æ˜¯å¾ˆæ˜ç¡®ã€‚:weary:

```cpp
bool QgsVctFeatureIterator::fetchFeature(QgsFeature &feature) {
    feature.setValid(false);
    if (mClosed)
        return false;
    if (mSelectIterator != mSource->mFeatures.constEnd()) {
        feature = mSelectIterator.value();
        feature.setValid(true);
        feature.setFields(mSource->mFields);
        geometryToDestinationCrs(feature, mTransform);
        ++mSelectIterator;
        return true;
    }
    else {
        close();
        return false;
    }
}
```

#### 2.2.4 QgsVctProviderMetadata

![QgsVctProviderMetadata](https://img-blog.csdnimg.cn/20201029193202817.png#pic_center)

*QgsVctProviderMetadata*ä¸­éœ€è¦å¯¹uriè¿›è¡Œå¤„ç†ï¼Œè€Œç”±äºæˆ‘åœ¨è¯»å–vctæ–‡ä»¶æ—¶uriç›´æ¥æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå› æ­¤è¿™é‡Œå°±æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ˜¯è¿æ¥æ•°æ®åº“ç­‰ï¼Œè¿™é‡Œå°±éœ€è¦æä¾›è¯·æ±‚å‚æ•°ç­‰ã€‚

```cpp
QVariantMap QgsVctProviderMetadata::decodeUri(const QString &uri ) {
    QVariantMap components;
    components.insert(QStringLiteral("path"), QUrl(uri).toLocalFile());
    return components;
}

QString QgsVctProviderMetadata::encodeUri(const QVariantMap &parts) {
    return QStringLiteral("file://%1").arg(parts.value(QStringLiteral("path")).toString());
}
```

#### 2.2.5 QgsVctSourceSelectProvider

![QgsVctSourceSelectProvider](https://img-blog.csdnimg.cn/20201029193226239.png#pic_center)

åœ¨*QgsVctSourceSelectProvider*ä¸­éœ€è¦å®ç°*providerKey*ã€*text*ã€*ordering*ã€*icon*å’Œ*createDataSourceWidget*å‡½æ•°ã€‚*providerKey*å’Œ*text*æ˜¯ç®€å•çš„è¿”å›å¯¹åº”çš„keyå’Œè¯´æ˜æ–‡å­—ã€‚*ordering*å°†å®šä¹‰æˆ‘ä»¬çš„dataProvideråœ¨QgsDataSourceManagerçª—å£ä¸­çš„ä½ç½®ï¼ŒæŸ¥çœ‹æºä»£ç å¯çŸ¥QGISè‡ªæœ‰é¡ºåºçš„è§„å®šã€‚å› æ­¤ï¼Œæˆ‘ä»¬ç›¸å…³ä»£ç ä¸­å°†é¡ºåºå®šä½äº*OrderLocalProvider*ä¹‹åã€‚è¿™é‡Œç”±äºæ²¡æœ‰è®¾è®¡VCTæ–‡ä»¶çš„å›¾æ ‡ï¼Œå› æ­¤*icon*è¿™é‡Œæ²¡è¿”å›æœ‰æ„ä¹‰çš„å€¼ã€‚

```cpp
    //! Provider ordering groups
    enum Ordering
    {
      OrderLocalProvider = 0, //!< Starting point for local file providers (e.g. OGR)
      OrderDatabaseProvider = 1000, //!< Starting point for database providers (e.g. Postgres)
      OrderRemoteProvider = 2000, //!< Starting point for remote (online) providers (e.g. WMS)
      OrderGeoCmsProvider = 3000, //!< Starting point for GeoCMS type providers (e.g. GeoNode)
      OrderOtherProvider = 4000, //!< Starting point for other providers (e.g. plugin based providers)
    };
```

```cpp
    int ordering() const override { return QgsSourceSelectProvider::OrderLocalProvider + 20; }
    QIcon icon() const override { return QgsApplication::getThemeIcon(QStringLiteral("")); }
    QgsAbstractDataSourceWidget *createDataSourceWidget(QWidget *parent = nullptr, Qt::WindowFlags fl = Qt::Widget, QgsProviderRegistry::WidgetMode widgetMode = QgsProviderRegistry::WidgetMode::Embedded) const override {
        return new QgsVctSourceSelect(parent, fl,widgetMode);
    }
```

#### 2.2.6 QgsVctProviderGuiMetadata

![QgsVctProviderGuiMetadata](https://img-blog.csdnimg.cn/20201029193507702.png#pic_center)

*QgsVctProviderGuiMetadata*ä¸­éœ€è¦æ³¨æ„*sourceSelectProviders*å‡½æ•°ã€‚

```cpp
    QList<QgsSourceSelectProvider *> sourceSelectProviders() override {
        QList<QgsSourceSelectProvider *> providers;
        providers << new QgsVctSourceSelectProvider;
        return providers;
    }
```

#### 2.2.7 QgsVctSourceSelect

![QgsVctSourceSelect](https://img-blog.csdnimg.cn/20201029193314824.png#pic_center)

*QgsVctSourceSelect*æ˜¯æˆ‘ä»¬å†…åµŒåœ¨*QgsDataSourceManager*çª—å£ä¸­çš„æ–‡ä»¶é€‰æ‹©çª—å£ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦åˆ©ç”¨Qt Designerè®¾è®¡ä¸€ä¸ª.uiæ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨å…¶å‘½ä»¤è¡Œå·¥å…·å°†uiæ–‡ä»¶è½¬æ¢ä¸º.hæ–‡ä»¶ï¼Œç„¶ååœ¨æˆ‘ä»¬çš„ç±»ä¸­å®ç°ç©ºé—´çš„è¿æ¥å’Œä¿¡å·å¤„ç†ã€‚.uiæ–‡ä»¶ä¸­ä¸€å®šè¦æœ‰ä¸€ä¸ªQDialogButtonBoxæ§ä»¶ï¼Œä»¥ä¾¿QGISåœ¨å…¶ä¸­æ”¾ç½®è‡ªå·±çš„ç¡®è®¤æŒ‰é’®ã€‚

```cpp
QgsVctSourceSelect::QgsVctSourceSelect(QWidget *parent, Qt::WindowFlags fl, QgsProviderRegistry::WidgetMode theWidgetMode)
    : QgsAbstractDataSourceWidget( parent, fl, theWidgetMode ) {
    setupUi(this);
    QgsGui::instance()->enableAutoGeometryRestore(this);
    setupButtons(buttonBox);

    connect(toolButtonFilePath, &QAbstractButton::clicked, this, &QgsVctSourceSelect::openFileDialog);
    connect(lineEditFilePath, &QLineEdit::textChanged, this, &QgsVctSourceSelect::onFileChanged);

}
```

## 3. æ€»ç»“

â€‹ä»¥ä¸Šå†…å®¹ç®€å•çš„å®ç°äº†QGISä¸­å…¶ä»–çŸ¢é‡æ•°æ®æ–‡ä»¶æ ¼å¼çš„è¯»å–ï¼Œå…¶ä»–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚åˆ›å»ºç©ºé—´ç´¢å¼•ã€ä¿®æ”¹è¦ç´ ç­‰åŠŸèƒ½åˆ™éœ€è¦æ”¹å˜*QgsVectorDataProvider*çš„*Capability*ä¸­çš„è¿”å›å€¼ï¼Œç„¶åæŒ‰ç…§è¦æ±‚å®ç°æŒ‡å®šå‡½æ•°å³å¯ã€‚Againï¼Œé¡¹ç›®çš„ä»£ç è§[Github](https://github.com/Falldio/QgsVctDataProvider/)ã€‚:tada::tada::tada:
